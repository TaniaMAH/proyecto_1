import{cursor as u,erase as l}from"sisteransi";import{stdin as f,stdout as m}from"node:process";import*as a from"node:readline";import d from"node:readline";import{WriteStream as k}from"node:tty";import o from"picocolors";function V(i,s){if(i===s)return;const t=i.split(`
`),e=s.split(`
`),r=[];for(let h=0;h<Math.max(t.length,e.length);h++)t[h]!==e[h]&&r.push(h);return r}const v=Symbol("clack:cancel");function C(i){return i===v}function c(i,s){i.isTTY&&i.setRawMode(s)}const b=new Map([["k","up"],["j","down"],["h","left"],["l","right"]]),y=new Set(["up","down","left","right","space","enter"]);class n{constructor({render:s,input:t=f,output:e=m,...r},h=!0){this._track=!1,this._cursor=0,this.state="initial",this.error="",this.subscribers=new Map,this._prevFrame="",this.opts=r,this.onKeypress=this.onKeypress.bind(this),this.close=this.close.bind(this),this.render=this.render.bind(this),this._render=s.bind(this),this._track=h,this.input=t,this.output=e}prompt(){const s=new k(0);return s._write=(t,e,r)=>{this._track&&(this.value=this.rl.line.replace(/\t/g,""),this._cursor=this.rl.cursor,this.emit("value",this.value)),r()},this.input.pipe(s),this.rl=d.createInterface({input:this.input,output:s,tabSize:2,prompt:"",escapeCodeTimeout:50}),d.emitKeypressEvents(this.input,this.rl),this.rl.prompt(),this.opts.initialValue!==void 0&&this._track&&this.rl.write(this.opts.initialValue),this.input.on("keypress",this.onKeypress),c(this.input,!0),this.render(),new Promise((t,e)=>{this.once("submit",()=>{this.output.write(u.show),c(this.input,!1),t(this.value)}),this.once("cancel",()=>{this.output.write(u.show),c(this.input,!1),t(v)})})}on(s,t){const e=this.subscribers.get(s)??[];e.push({cb:t}),this.subscribers.set(s,e)}once(s,t){const e=this.subscribers.get(s)??[];e.push({cb:t,once:!0}),this.subscribers.set(s,e)}emit(s,...t){const e=this.subscribers.get(s)??[],r=[];for(const h of e)h.cb(...t),h.once&&r.push(()=>e.splice(e.indexOf(h),1));for(const h of r)h()}unsubscribe(){this.subscribers.clear()}onKeypress(s,t){if(this.state==="error"&&(this.state="active"),t?.name&&!this._track&&b.has(t.name)&&this.emit("cursor",b.get(t.name)),t?.name&&y.has(t.name)&&this.emit("cursor",t.name),s&&(s.toLowerCase()==="y"||s.toLowerCase()==="n")&&this.emit("confirm",s.toLowerCase()==="y"),t?.name==="return"){if(this.opts.validate){const e=this.opts.validate(this.value);e&&(this.error=e,this.state="error",this.rl.write(this.value))}this.state!=="error"&&(this.state="submit")}s===""&&(this.state="cancel"),(this.state==="submit"||this.state==="cancel")&&this.emit("finalize"),this.render(),(this.state==="submit"||this.state==="cancel")&&this.close()}close(){this.input.unpipe(),this.input.removeListener("keypress",this.onKeypress),this.output.write(`
`),c(this.input,!1),this.rl.close(),this.emit(`${this.state}`,this.value),this.unsubscribe()}restoreCursor(){const s=this._prevFrame.split(`
`).length-1;this.output.write(u.move(-999,s*-1))}render(){const s=this._render(this)??"";if(s!==this._prevFrame){if(this.state==="initial")this.output.write(u.hide);else{const t=V(this._prevFrame,s);if(this.restoreCursor(),t&&t?.length===1){const e=t[0];this.output.write(u.move(0,e)),this.output.write(l.lines(1));const r=s.split(`
`);this.output.write(r[e]),this._prevFrame=s,this.output.write(u.move(0,r.length-e-1));return}else if(t&&t?.length>1){const e=t[0];this.output.write(u.move(0,e)),this.output.write(l.down());const h=s.split(`
`).slice(e);this.output.write(h.join(`
`)),this._prevFrame=s;return}this.output.write(l.down())}this.output.write(s),this.state==="initial"&&(this.state="active"),this._prevFrame=s}}}class $ extends n{get cursor(){return this.value?0:1}get _value(){return this.cursor===0}constructor(s){super(s,!1),this.value=!!s.initialValue,this.on("value",()=>{this.value=this._value}),this.on("confirm",t=>{this.output.write(u.move(0,-1)),this.value=t,this.state="submit",this.close()}),this.on("cursor",()=>{this.value=!this.value})}}class x extends n{constructor(s){s.validate||(s.validate=()=>{if(s.required&&this.selectedValues.length===0)return`Please select at least one option
${o.reset(o.dim(`Press ${o.gray(o.bgWhite(o.inverse(" space ")))} to select, ${o.gray(o.bgWhite(o.inverse(" enter ")))} to submit`))}`}),super(s,!1),this.cursor=0,this.once("finalize",()=>{this.value=this.selectedValues}),this.options=s.options,this.cursor=this.options.findIndex(({value:t})=>t===s.cursorAt),this.selectedValues=s.initialValue||[],this.cursor===-1&&(this.cursor=0),this.on("cursor",t=>{switch(t){case"left":case"up":this.cursor=this.cursor===0?this.options.length-1:this.cursor-1;break;case"down":case"right":this.cursor=this.cursor===this.options.length-1?0:this.cursor+1;break;case"space":this.changeValue();break;case"enter":case"return":this.state="submit",this.close();break}})}get _value(){return this.options[this.cursor]}changeValue(){this.selectedValues.some(t=>t===this._value.value)?this.selectedValues=this.selectedValues.filter(t=>t!==this._value.value):this.selectedValues.push(this._value.value)}}class L extends n{constructor({mask:s,...t}){super(t),this.valueWithCursor="",this._mask="\u2022",this._mask=s??"\u2022",this.on("finalize",()=>{this.valueWithCursor=this.masked}),this.on("value",()=>{if(this.cursor>=this.value.length)this.valueWithCursor=`${this.masked}${o.inverse(o.hidden("_"))}`;else{const e=this.masked.slice(0,this.cursor),r=this.masked.slice(this.cursor);this.valueWithCursor=`${e}${o.inverse(r[0])}${r.slice(1)}`}})}get cursor(){return this._cursor}get masked(){return this.value.split("").map(()=>this._mask).join("")}}class W extends n{constructor(s){super(s,!1),this.cursor=0,this.options=s.options,this.cursor=this.options.findIndex(({value:t})=>t===s.initialValue),this.cursor===-1&&(this.cursor=0),this.changeValue(),this.on("cursor",t=>{switch(t){case"left":case"up":this.cursor=this.cursor===0?this.options.length-1:this.cursor-1;break;case"down":case"right":this.cursor=this.cursor===this.options.length-1?0:this.cursor+1;break}this.changeValue()})}get _value(){return this.options[this.cursor]}changeValue(){this.value=this._value.value}}class P extends n{constructor(s){super(s),this.valueWithCursor="",this.on("finalize",()=>{this.value||(this.value=s.defaultValue),this.valueWithCursor=this.value}),this.on("value",()=>{if(this.cursor>=this.value.length)this.valueWithCursor=`${this.value}${o.inverse(o.hidden("_"))}`;else{const t=this.value.slice(0,this.cursor),e=this.value.slice(this.cursor);this.valueWithCursor=`${t}${o.inverse(e[0])}${e.slice(1)}`}})}get cursor(){return this._cursor}}function S({input:i=f,output:s=m,overwrite:t=!0,hideCursor:e=!0}={}){const r=a.createInterface({input:i,output:s,prompt:"",tabSize:1});a.emitKeypressEvents(i,r),i.isTTY&&i.setRawMode(!0);const h=(w,{name:p})=>{if(String(w)===""&&process.exit(0),!t)return;let g=p==="return"?0:-1,_=p==="return"?-1:0;a.moveCursor(s,g,_,()=>{a.clearLine(s,1,()=>{i.once("keypress",h)})})};return e&&process.stdout.write(u.hide),i.once("keypress",h),()=>{i.off("keypress",h),e&&process.stdout.write(u.show),r.close()}}export{$ as ConfirmPrompt,x as MultiSelectPrompt,L as PasswordPrompt,n as Prompt,W as SelectPrompt,P as TextPrompt,S as block,C as isCancel};
