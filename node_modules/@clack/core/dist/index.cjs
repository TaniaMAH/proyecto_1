"use strict";const sisteransi=require("sisteransi"),node_process=require("node:process"),readline=require("node:readline"),node_tty=require("node:tty"),color=require("picocolors");function _interopNamespaceDefault(i){const s=Object.create(null);if(i)for(const t in i)s[t]=i[t];return s.default=i,s}const readline__namespace=_interopNamespaceDefault(readline);function diffLines(i,s){if(i===s)return;const t=i.split(`
`),e=s.split(`
`),r=[];for(let o=0;o<Math.max(t.length,e.length);o++)t[o]!==e[o]&&r.push(o);return r}const cancel=Symbol("clack:cancel");function isCancel(i){return i===cancel}function setRawMode(i,s){i.isTTY&&i.setRawMode(s)}const aliases=new Map([["k","up"],["j","down"],["h","left"],["l","right"]]),keys=new Set(["up","down","left","right","space","enter"]);class Prompt{constructor({render:s,input:t=node_process.stdin,output:e=node_process.stdout,...r},o=!0){this._track=!1,this._cursor=0,this.state="initial",this.error="",this.subscribers=new Map,this._prevFrame="",this.opts=r,this.onKeypress=this.onKeypress.bind(this),this.close=this.close.bind(this),this.render=this.render.bind(this),this._render=s.bind(this),this._track=o,this.input=t,this.output=e}prompt(){const s=new node_tty.WriteStream(0);return s._write=(t,e,r)=>{this._track&&(this.value=this.rl.line.replace(/\t/g,""),this._cursor=this.rl.cursor,this.emit("value",this.value)),r()},this.input.pipe(s),this.rl=readline.createInterface({input:this.input,output:s,tabSize:2,prompt:"",escapeCodeTimeout:50}),readline.emitKeypressEvents(this.input,this.rl),this.rl.prompt(),this.opts.initialValue!==void 0&&this._track&&this.rl.write(this.opts.initialValue),this.input.on("keypress",this.onKeypress),setRawMode(this.input,!0),this.render(),new Promise((t,e)=>{this.once("submit",()=>{this.output.write(sisteransi.cursor.show),setRawMode(this.input,!1),t(this.value)}),this.once("cancel",()=>{this.output.write(sisteransi.cursor.show),setRawMode(this.input,!1),t(cancel)})})}on(s,t){const e=this.subscribers.get(s)??[];e.push({cb:t}),this.subscribers.set(s,e)}once(s,t){const e=this.subscribers.get(s)??[];e.push({cb:t,once:!0}),this.subscribers.set(s,e)}emit(s,...t){const e=this.subscribers.get(s)??[],r=[];for(const o of e)o.cb(...t),o.once&&r.push(()=>e.splice(e.indexOf(o),1));for(const o of r)o()}unsubscribe(){this.subscribers.clear()}onKeypress(s,t){if(this.state==="error"&&(this.state="active"),t?.name&&!this._track&&aliases.has(t.name)&&this.emit("cursor",aliases.get(t.name)),t?.name&&keys.has(t.name)&&this.emit("cursor",t.name),s&&(s.toLowerCase()==="y"||s.toLowerCase()==="n")&&this.emit("confirm",s.toLowerCase()==="y"),t?.name==="return"){if(this.opts.validate){const e=this.opts.validate(this.value);e&&(this.error=e,this.state="error",this.rl.write(this.value))}this.state!=="error"&&(this.state="submit")}s===""&&(this.state="cancel"),(this.state==="submit"||this.state==="cancel")&&this.emit("finalize"),this.render(),(this.state==="submit"||this.state==="cancel")&&this.close()}close(){this.input.unpipe(),this.input.removeListener("keypress",this.onKeypress),this.output.write(`
`),setRawMode(this.input,!1),this.rl.close(),this.emit(`${this.state}`,this.value),this.unsubscribe()}restoreCursor(){const s=this._prevFrame.split(`
`).length-1;this.output.write(sisteransi.cursor.move(-999,s*-1))}render(){const s=this._render(this)??"";if(s!==this._prevFrame){if(this.state==="initial")this.output.write(sisteransi.cursor.hide);else{const t=diffLines(this._prevFrame,s);if(this.restoreCursor(),t&&t?.length===1){const e=t[0];this.output.write(sisteransi.cursor.move(0,e)),this.output.write(sisteransi.erase.lines(1));const r=s.split(`
`);this.output.write(r[e]),this._prevFrame=s,this.output.write(sisteransi.cursor.move(0,r.length-e-1));return}else if(t&&t?.length>1){const e=t[0];this.output.write(sisteransi.cursor.move(0,e)),this.output.write(sisteransi.erase.down());const o=s.split(`
`).slice(e);this.output.write(o.join(`
`)),this._prevFrame=s;return}this.output.write(sisteransi.erase.down())}this.output.write(s),this.state==="initial"&&(this.state="active"),this._prevFrame=s}}}class ConfirmPrompt extends Prompt{get cursor(){return this.value?0:1}get _value(){return this.cursor===0}constructor(s){super(s,!1),this.value=!!s.initialValue,this.on("value",()=>{this.value=this._value}),this.on("confirm",t=>{this.output.write(sisteransi.cursor.move(0,-1)),this.value=t,this.state="submit",this.close()}),this.on("cursor",()=>{this.value=!this.value})}}class MultiSelectPrompt extends Prompt{constructor(s){s.validate||(s.validate=()=>{if(s.required&&this.selectedValues.length===0)return`Please select at least one option
${color.reset(color.dim(`Press ${color.gray(color.bgWhite(color.inverse(" space ")))} to select, ${color.gray(color.bgWhite(color.inverse(" enter ")))} to submit`))}`}),super(s,!1),this.cursor=0,this.once("finalize",()=>{this.value=this.selectedValues}),this.options=s.options,this.cursor=this.options.findIndex(({value:t})=>t===s.cursorAt),this.selectedValues=s.initialValue||[],this.cursor===-1&&(this.cursor=0),this.on("cursor",t=>{switch(t){case"left":case"up":this.cursor=this.cursor===0?this.options.length-1:this.cursor-1;break;case"down":case"right":this.cursor=this.cursor===this.options.length-1?0:this.cursor+1;break;case"space":this.changeValue();break;case"enter":case"return":this.state="submit",this.close();break}})}get _value(){return this.options[this.cursor]}changeValue(){this.selectedValues.some(t=>t===this._value.value)?this.selectedValues=this.selectedValues.filter(t=>t!==this._value.value):this.selectedValues.push(this._value.value)}}class PasswordPrompt extends Prompt{constructor({mask:s,...t}){super(t),this.valueWithCursor="",this._mask="\u2022",this._mask=s??"\u2022",this.on("finalize",()=>{this.valueWithCursor=this.masked}),this.on("value",()=>{if(this.cursor>=this.value.length)this.valueWithCursor=`${this.masked}${color.inverse(color.hidden("_"))}`;else{const e=this.masked.slice(0,this.cursor),r=this.masked.slice(this.cursor);this.valueWithCursor=`${e}${color.inverse(r[0])}${r.slice(1)}`}})}get cursor(){return this._cursor}get masked(){return this.value.split("").map(()=>this._mask).join("")}}class SelectPrompt extends Prompt{constructor(s){super(s,!1),this.cursor=0,this.options=s.options,this.cursor=this.options.findIndex(({value:t})=>t===s.initialValue),this.cursor===-1&&(this.cursor=0),this.changeValue(),this.on("cursor",t=>{switch(t){case"left":case"up":this.cursor=this.cursor===0?this.options.length-1:this.cursor-1;break;case"down":case"right":this.cursor=this.cursor===this.options.length-1?0:this.cursor+1;break}this.changeValue()})}get _value(){return this.options[this.cursor]}changeValue(){this.value=this._value.value}}class TextPrompt extends Prompt{constructor(s){super(s),this.valueWithCursor="",this.on("finalize",()=>{this.value||(this.value=s.defaultValue),this.valueWithCursor=this.value}),this.on("value",()=>{if(this.cursor>=this.value.length)this.valueWithCursor=`${this.value}${color.inverse(color.hidden("_"))}`;else{const t=this.value.slice(0,this.cursor),e=this.value.slice(this.cursor);this.valueWithCursor=`${t}${color.inverse(e[0])}${e.slice(1)}`}})}get cursor(){return this._cursor}}function block({input:i=node_process.stdin,output:s=node_process.stdout,overwrite:t=!0,hideCursor:e=!0}={}){const r=readline__namespace.createInterface({input:i,output:s,prompt:"",tabSize:1});readline__namespace.emitKeypressEvents(i,r),i.isTTY&&i.setRawMode(!0);const o=(u,{name:n})=>{if(String(u)===""&&process.exit(0),!t)return;let h=n==="return"?0:-1,c=n==="return"?-1:0;readline__namespace.moveCursor(s,h,c,()=>{readline__namespace.clearLine(s,1,()=>{i.once("keypress",o)})})};return e&&process.stdout.write(sisteransi.cursor.hide),i.once("keypress",o),()=>{i.off("keypress",o),e&&process.stdout.write(sisteransi.cursor.show),r.close()}}exports.ConfirmPrompt=ConfirmPrompt,exports.MultiSelectPrompt=MultiSelectPrompt,exports.PasswordPrompt=PasswordPrompt,exports.Prompt=Prompt,exports.SelectPrompt=SelectPrompt,exports.TextPrompt=TextPrompt,exports.block=block,exports.isCancel=isCancel;
